% Created 2023-08-28 月 11:24
% Intended LaTeX compiler: pdflatex
\documentclass[10pt]{article}
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{longtable}
\usepackage{wrapfig}
\usepackage{rotating}
\usepackage[normalem]{ulem}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{capt-of}
\usepackage{hyperref}
\usepackage[newfloat]{minted}
\usepackage[a4paper, total={6.5in, 9in}]{geometry}
\usepackage{minted}
\setminted{breaklines}
\usepackage[utf8]{inputenc}
\renewcommand{\familydefault}{\sfdefault}
\usemintedstyle{vs}
\usepackage[most]{tcolorbox}
\usepackage{CJKutf8}
\usepackage{xurl}
\usepackage{fontawesome5}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{float}
\newcommand{\gitlab}[1]{%
\href{#1}{GitLab \faGitlab}}
\author{Vincent Conus}
\date{2023-8-24}
\title{Setting up and using Xilinx KRIA KV260\\\medskip
\large \begin{CJK}{UTF8}{min}南山大学\end{CJK}}
\hypersetup{
 pdfauthor={Vincent Conus},
 pdftitle={Setting up and using Xilinx KRIA KV260},
 pdfkeywords={},
 pdfsubject={A report presenting how to use and set Xilinx's Kria board},
 pdfcreator={Emacs 30.0.50 (Org mode 9.6.6)}, 
 pdflang={English}}
\begin{document}

\begin{titlepage}
\centering
{\LARGE Setting up and using Xilinx KRIA KV260 \par }
\vspace{5mm}
{\large \begin{CJK}{UTF8}{min}南山大学\end{CJK} \par}
\vspace{1cm}
{\large 2023-8-24 \par}
\vspace{2cm}
{\large Vincent Conus -  Source available at \gitlab{https://gitlab.com/sunoc/xilinx-kria-kv260-documentation} \par}
\vspace{3cm}
\includegraphics[width=0.8\textwidth]{./img/board}\end{titlepage}
\tableofcontents
\pagebreak
\section{Introduction}
\label{sec:orgdedcfe0}

\subsection{Motivation}
\label{sec:org46bb604}
This guide will present how to setup and use Xilinx's KRIA board, in particular
for running ROS on a host Ubuntu system, as well as for deploying
micro-ROS as a firmware on the MCU part of this board's chip.

The use of this device in particular is interesting because of the presence
of a CPU comprising both a general purpose ARM core, capable of running
a Linux distribution, as well as another ARM core, real-time enabled,
capable to run a RTOS.

\subsection{Build instructions for this report}
\label{sec:orge612cea}
The base file for this report is actually this README.org file itself.
However, upon local build, this file is regularly exported as
a \texttt{.tex} file that can be built normally.
On a moderately recent Ubuntu-base distribution, the following packages seemed to be required to build the
report:

\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{bash}
sudo apt-get install texlive-base texlive-latex-recommended texlive-lang-japanese
\end{minted}

Then, the actual build can be made with a simple:

\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{bash}
pdflatex instructions.tex
\end{minted}

No fancy Lua or theme at the moment !

\subsubsection{Automatic build with CI/CD pipeline}
\label{sec:org6510b19}
If you don't want to build the report yourself, a CI pipeline is used to make it on GitLab.

You can check the steps in the .gitlab-ci.yml file.
This build uses a base Ubuntu image and basically takes the same steps as presented above for a local build.

A PDF artifact can be downloaded.

\subsubsection{Headers and \LaTeX{} settings for export}
\label{sec:orgdb75034}
A large amount of headers and parameters are needed in order
to have this "README" document being exportable as a \LaTeX{}
document formatted the way I wanted it to be.

The detail can be seen in the raw \texttt{.org} version of this README.

\section{Boot firmware}
\label{sec:orga38c67f}
The goal for the Linux side of the deployment is to
have the latest LTS version of Ubuntu up and running.
In order to be able to boot such a newer version of Linux, the
boot image of the board must first be updated.

The procedure is available in \href{https://docs.xilinx.com/r/en-US/ug1089-kv260-starter-kit/Firmware-Update}{the official documentation},
but I will present it step by step here.

\subsection{Getting the new firmware}
\label{sec:orgfec388b}
A 2022 version of the board firmware is required in order to run the latest
version of Ubuntu properly.

The image can be downloaded at \href{https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/1641152513/Kria+K26+ SOMoot-FW-update-with-xmutil}{the atlassian page} on the topic,
or even directly with the following command:

\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{sh}
wget https://www.xilinx.com/member/forms/download/\
     design-license-xef.html?filename=BOOT-k26-starter-kit-20230516185703.bin
\end{minted}


\subsection{Reaching the board recovery tool}
\label{sec:org02fa073}
Now the firmware \texttt{.bin} image is available, it is possible to update it using the
boards recovery tool. Here are the steps that must be taken in order to reach
this tool and update the board:

\begin{itemize}
\item Connect the board to your machine via a Ethernet cable.
This will obviously cut you internet access, so you should be set for that.
\item Select the wired network as your connection (must be "forced", since it
doesn't have internet access).
\item Set a fixed IP address for your machine, in the \texttt{192.168.0.1/24}
range, except the specific \texttt{192.168.0.111}, which will be used by the
board.
\item Using a web browser on your host machine, access
\texttt{http://192.168.0.111}. Thou shall now see the interface, as visible on
the figure \ref{fig:org92c221a} below.
\end{itemize}

\begin{figure}[htbp]
\centering
\includegraphics[width=1\textwidth]{img/recovery.png}
\caption{\label{fig:org92c221a}The recovery tool for the board, access from Firefox. We can see board information at the center, and the tools to upload the firmware at the bottom of the page.}
\end{figure}

\subsection{Updating the boot firmware}
\label{sec:org5c16868}
From this "recovery" page, it is possible to upload the \texttt{.bin} file downloaded previously onto
the board using the "Recover Image" section at the bottom right of the page.

The board can be re-booted afterwards.

\section{Installing Linux}
\label{sec:org3cff78f}
Withe the boot firmware being up-to-date, we can proceed to install a Linux distribution
on our Kria board. The step needed to archive a full installation of Ubuntu 22.04
will be presented in this section.

\subsection{Preparing and booting a Ubuntu 22.04 media}
\label{sec:orgea42e47}
An \href{https://ubuntu.com/download/amd-xilinx}{official Ubuntu image} exists and is
provided by Xilinx, allowing the OS installation to be quick and
straightforward.
Ubuntu is a common and easy to use distribution. Furthermore,
it allows to install ROS2 as a package, which is most convenient and will be
done later in this guide.

Once the image has been downloaded at \href{https://ubuntu.com/download/amd-xilinx}{Canonical's page}
we can flash it onto the SD card, with the following instructions.

\begin{tcolorbox}[colback=red!5!white,colframe=red!75!black]
\textbf{WARNING}: The next part involve the \texttt{dd} command writing on disks!!!
As always with the dd command, thou have to be \textbf{VERY} careful on what arguments
thou give. Selecting the wrong disk will result on the destruction of
thy data !!
\uline{If you are unsure of what to do, seek assistance !}
\end{tcolorbox}

With the image available on thy machine and a SD card visible as \texttt{/dev/sda}
Once the SD card is flashed and put back in the board, the micro-USB cable can be
connected from the PC to the board. It is then possible to
connect to the board in serial with an appropriate tool, for example \texttt{picocom},
as in the following example (the serial port that "appeared" was the \texttt{/dev/ttyUSB1} in this case,
and the 115200 bitrate is the default value for the board):

\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{sh}
sudo picocom /dev/ttyUSB1 -b 115200
\end{minted}

Once logged in, it is typically easier and more convenient to connect the board
using SSH. When the board is connected to the network, it is possible to know
it's IP address with the \texttt{ip} command; then it is possible to connect to
the board with ssh, as follow (example, with the first command to be run on the board
and the second one on the host PC, both without the first placeholder hostnames):


\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{sh}
kria# ip addr

host# ssh ubuntu@192.168.4.11
\end{minted}




\section{Enabling \texttt{remoteproc}}
\label{sec:org3dc7709}

\section{Loading a real-time firmware}
\label{sec:org78baf27}

\section{Building micro-ROS as a static library}
\label{sec:org345d87f}

\section{Building a real-time firmware}
\label{sec:org11f8af4}

\subsection{Setting up Vitis IDE}
\label{sec:orgba70921}

\section{Adding micro-ROS to a firmware project}
\label{sec:org670a61a}

\section{Loading a real-time firmware}
\label{sec:org63f4f75}

\section{Running a ROS2 node}
\label{sec:org83038b9}

\subsection{On the host Linux}
\label{sec:org475f146}

\subsection{In a container}
\label{sec:orge59ba94}

\section{micro-ROS agent}
\label{sec:orgbea9cf5}

\pagebreak
\appendix
\section{DTO patch}
\label{sec:org8bbe32f}
\inputminted[linenos, frame=single]{diff}{./src/system.patch}

\pagebreak
\section{Custom toolchain CMake settings}
\label{sec:org6932bfb}
\inputminted[linenos, frame=single]{cmake}{./src/custom_r5f_toolchain.cmake}

\pagebreak
\section{Custom Colcon meta settings}
\label{sec:org8dce447}
\inputminted[linenos, frame=single]{yaml}{./src/custom_r5f_colcon.meta}

\pagebreak
\section{Firmware time functions}
\label{sec:orgbf95aa8}

\subsection{main}
\label{sec:orgbceba22}
\inputminted[linenos, frame=single]{c}{./src/clock.c}

\subsection{header file}
\label{sec:org7606769}
\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{c}
/**< Microseconds per second. */
#define MICROSECONDS_PER_SECOND    ( 1000000LL )  
/**< Nanoseconds per second. */
#define NANOSECONDS_PER_SECOND     ( 1000000000LL ) 
/**< Nanoseconds per FreeRTOS tick. */  
#define NANOSECONDS_PER_TICK       ( NANOSECONDS_PER_SECOND / configTICK_RATE_HZ ) 
\end{minted}


\pagebreak
\section{Firmware memory allocation functions}
\label{sec:org9b92456}

\subsection{main}
\label{sec:orgeeb3b58}
\inputminted[linenos, frame=single]{c}{./src/allocators.c}

\subsection{header file}
\label{sec:org2aa0e40}
\begin{minted}[frame=single,framesep=2mm,baselinestretch=1.2,linenos,breaklines,fontsize=\footnotesize]{c}
#ifndef _ALLOCATORS_H_
#define _ALLOCATORS_H_

#include "microros.h"

extern int absoluteUsedMemory;
extern int usedMemory;


void * __freertos_allocate(size_t size, void * state);
void __freertos_deallocate(void * pointer, void * state);
void * __freertos_reallocate(void * pointer, size_t size, void * state);
void * __freertos_zero_allocate(size_t number_of_elements,
size_t size_of_element, void * state);

#endif // _ALLOCATORS_H_
\end{minted}
\end{document}